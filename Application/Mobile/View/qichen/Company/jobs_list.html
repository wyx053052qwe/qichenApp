<!DOCTYPE html>
<html>
	<head>
        <link rel="stylesheet" type="text/css" href="../public_qichen/css/style.css">
		<include file="public:meta" />
		<link rel="stylesheet" href="../public/css/company.css">
	</head>
    <style>
        body{
            font-size: 0.3rem;
        }
        .jobs-manager-top-nav .n-cell.active {
            color: #f2b300;
        }
        .jobs-manager-top-nav .n-cell .b-line {
            display: none;
            position: absolute;
            top: 1.02rem;
            width: 100%;
            height: .03rem;
            background: #f2b300;
        }
        .qs-btn-blue {
            background-color: #f2b300;
            position: relative;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
    </style>
	<body>
		<include file="public:header" />
		<div class="jobs-manager-top-nav list_height">
			<div class="n-cell <if condition="$Think.get.type eq 0 or $Think.get.type eq ''">active</if>" onclick="window.location='{:U('company/jobs_list')}'">全部职位<if condition="$Think.get.type eq 0 or $Think.get.type eq ''"><div class="b-line"></div></if></div>
			<div class="n-cell <if condition="$Think.get.type eq 1">active</if>" onclick="window.location='{:U('company/jobs_list',array('type'=>1))}'">发布中的<if condition="$Think.get.type eq 1 or $Think.get.type eq ''"><div class="b-line"></div></if></div>
			<div class="n-cell <if condition="$Think.get.type eq 2">active</if>" onclick="window.location='{:U('company/jobs_list',array('type'=>2))}'">未显示的<if condition="$Think.get.type eq 2"><div class="b-line"></div></if></div>
			<div class="clear"></div>
		</div>
		<div class="split-block"></div>
		<notempty name="jobs_list['list']">
			<volist name="jobs_list['list']" id="list">
				<div class="job js-actionParent">
					<div class="info" onclick="window.location='{$list.jobs_url}'">
						<div class="line-one">
							<div class="job-name substring">{$list.jobs_name}</div>
					        <if condition="$list['allowance_id'] gt 0 && C('apply.Allowance')">
							<div class="j-n-money">
				                <div class="j-m-l jm<eq name="list['allowance']['type_alias']" value="apply">2</eq><eq name="list['allowance']['type_alias']" value="interview">3</eq><eq name="list['allowance']['type_alias']" value="entry">1</eq>"></div>
				                <div class="j-m-r"><span class="font9">￥</span><span class="font12">{$list['allowance']['per_amount']}</span></div>
				                <div class="clear"></div>
				            </div>
				            </if>
							<div class="job-status font12 <if condition="$list['_audit'] eq 2">font_yellow<elseif condition="$list['_audit'] eq 3 || $list['display'] eq 2" />font_red</if>">{$list.status_cn}</div>
							<div class="clear"></div>
						</div>
						<div class="line-two font12">{$list.district_cn} | {$list.nature_cn} | 经验{$list.experience_cn} | {$list.wage_cn}</div>
						<div class="line-three font12">
							<div class="pic apply">投递{$list.applys|default="0"}次</div>
							<div class="pic browse">浏览{$list.views|default="0"}次</div>
							<div class="pic refresh">{:date('Y-m-d H:i',$list['refreshtime'])}</div>
							<div class="clear"></div>
						</div>
					</div>
					<div class="handler font14">
						<div class="item" onclick="window.location='{:U('company/jobs_apply',array('stop'=>1,'jobs_id'=>$list['id']))}'"><span>简历</span></div>
						<div class="J_refresh item" yid="{$list.id}"><span>刷新</span></div>
						<div class="item J_promotion" data-audit="{$list['_audit']}" data-display="{$list['display']}" data-stick="{$list['stick']}" data-emergency="{$list['emergency']}" data-auto="{$list['auto_refresh']}" data-stickmsg="<strong>已购买【职位置顶】服务</strong><br /><span class='time'>开始时间：{:date('Y-m-d',$list['promotion']['stick']['starttime'])}<br />结束时间：{:date('Y-m-d',$list['promotion']['stick']['endtime'])}</span>" data-stickurl="{:U('companyService/service_stick',array('jobs_id'=>$list['id']))}" data-emergencymsg="<strong>已购买【紧急招聘】服务</strong><br /><span class='time'>开始时间：{:date('Y-m-d',$list['promotion']['emergency']['starttime'])}<br />结束时间：{:date('Y-m-d',$list['promotion']['emergency']['endtime'])}</span>" data-emergencyurl="{:U('companyService/service_emergency',array('jobs_id'=>$list['id']))}" data-automsg="<strong>已购买【智能刷新】服务</strong><br /><span class='time'>开始时间：{$list['auto_refresh_starttime']}<br />结束时间：{$list['auto_refresh_endtime']}</span>" data-autourl="{:U('companyService/service_refresh',array('jobs_id'=>$list['id']))}"><span>推广</span></div>
						<div class="item J_more" data-editurl="{:U('company/jobs_edit',array('id'=>$list['id']))}" data-audit="{$list['_audit']}" data-display="{$list['display']}" data-closeurl="{:U('company/jobs_close',array('id'=>$list['id']))}" data-recoverurl="{:U('company/jobs_display',array('id'=>$list['id']))}" data-delurl="{:U('company/jobs_delete',array('id'=>$list['id']))}" data-allowance="<if condition="$list['allowance_id'] eq 0 && C('apply.Allowance')">1<else />0</if>" data-allowanceurl="{:U('Company/set_allowance_job',array('jobsid'=>$list['id']))}"><span class="last">更多</span></div>
						<div class="clear"></div>
					</div>
				</div>
				<div class="split-block"></div>
			</volist>
			<div class="qspage">{$jobs_list['page']}</div>
			<div class="btn-spacing">
				<a class="qs-btn qs-btn-blue font18" id="J_jobs_add">发布职位</a>
			</div>
            <div class="split-block"></div>
		<else/>
			<if condition="$hasget">
				<div class="list-empty">
					抱歉，没有找到相关职位！
				</div>
			<else />
				<div class="list-empty link_blue">
					亲爱的HR，您还没有发布的职位！<br>
					想要快速找到合适的人才，就赶紧 <a id="J_jobs_add">发布职位</a> 吧~
				</div>
			</if>
		</notempty>
		      <include file="public_qichen:footer_geren_1" />
<script src="../public/js/fastclick.js"></script>
<script>
    window.addEventListener( "load", function() {
        FastClick.attach(document.body);
    }, false );
</script>
<script src="../public/js/QSpopout.js"></script>
<script src="../public/js/QSfilter.js"></script>
<script src="../public/js/zepto.hwSlider.js"></script>
<script src="../public/js/scrollTo.js"></script>
<script src="../public/js/RongIMLib-2.2.8.min.js"></script>
<script src="../public/js/qs.action.js"></script>
<script src="../public/js/qs.select.js"></script>
<script src="../public/js/dialog.js"></script>
<script src="https://static.geetest.com/static/tools/gt.js"></script>
<if condition="$rong_state eq 1">
<script src="../public/js/rong_main.js"></script>
</if>
<script>
    if (!$('.foot_pub_box_list li').length) {
        $('#JFootPub').remove();
        $('.fix-footNav').addClass('n4');
    }
    // 锁定屏幕
    function lockTouchMove(){
        //document.body.addEventListener('touchmove', handler, { passive: false })
        $("body").bind("touchmove",function(event){event.preventDefault()});
    }

    // 解锁屏幕
    function unLockTouchMove(){
        //document.body.removeEventListener('touchmove', handler, { passive: false })
        $("body").unbind("touchmove");
    }
    // 服务
    function closeFootPub() {
        $('.JFootPubNav').removeClass('slideInUp animated').addClass('slideOutDown animated'); unLockTouchMove();
    }
    $('#JFootPub').off().on('click', function() {
        lockTouchMove();
        $('.JFootPubNav').removeClass('slideOutDown animated').addClass('slideInUp animated');
        // 关闭
        $('#JFootPubClose').off().on('click', function() { closeFootPub(); });
    });
    $('a[href]').click(function() {
        var f = $(this).attr('href');
        var reg = /\#(\w+)/;
        if (reg.test(f)) {
            if (!$(this).data('nm')) {
                return !1;
            }
        }
    });
    $(".js-back").on('click',function(){
        /*if (history.length == 1){
            window.location.href = '{:U("index/index")}';
        } else {
            history.back();
        }*/
        history.back();
    });
    /**
     * 监听鼠标
     */
    if ('ontouchstart' in window) {
        $.EVENT_START = 'touchstart';
        $.EVENT_END = 'touchend';
    } else {
        $.EVENT_START = 'mousedown';
        $.EVENT_END = 'mouseup';
    }
    $('.plist-txt, .qs-btn, .for-event').on($.EVENT_START, function() {
        $(this).addClass('eventactive');
        /*if($(this).find('input[type="text"]').length) {
            $(this).find('input[type="text"]').focus();
        }*/
    });
    $('.plist-txt, .qs-btn, .for-event').on($.EVENT_END, function() {
        $(this).removeClass('eventactive');
    });
    $('.plist-txt, .qs-btn, .for-event').on('touchcancel', function() {
        $(this).removeClass('eventactive');
    });
    $('.logout').on('click', function() {
        forCloseNav();
        $(document).dialog({
            type: 'confirm',
            content: '确定退出吗？',
            onClickConfirmBtn: function() {
                window.location.href = "{:U('Members/logout')}";
            }
        });
    });
    /**
     * 返回顶部
     */
    var global = {
        h: $(window).height(),
        st: $(window).scrollTop(),
        backTop: function() {
            global.st > (global.h * 0.5) ? $("#backtop").show() : $("#backtop").hide();
        }
    };
    /**
     * Notice 提醒公用方法
     * @param infoText 提示文字
     */
    function qsNotice(infoText) {
        $(document).dialog({
            type : 'notice',
            infoText: infoText,
            autoClose: 1500,
            position: 'center',
            dialogClass: 'dialog_toast'
        });
    }
    // 定义Toast图片路径
    var loadingImg = '../public/images/dialog/loading.gif',
        successImg = '../public/images/dialog/success.png',
        failImg = '../public/images/dialog/fail.png',
        warningImg = '../public/images/dialog/warning.png';
    /**
     * 正在加载中
     * @param infoText 内容
     */
    function qsToasting() {
        var infoContent = arguments[0] ? arguments[0] : '';
        var closeTime = arguments[1] === 0 ? arguments[1] : 1500;
        var $cuToasting = $(document).dialog({
            type : 'toast',
            infoIcon: loadingImg,
            infoText: infoContent,
            autoClose: closeTime
        });
        return $cuToasting;
    }
    /**
     * Toast 类型通知 用于需要反馈结果
     * @param msg 反馈内容
     * @param type 反馈类型 可以不传参数有默认值 0->失败 1->成功
     * @param obj 正在加载对象 用于更新Toast
     */
    function qsToast(msg, type, obj) {
        type = arguments[1] ? arguments[1] : 2;
        var icons = [failImg, successImg, warningImg];
        var setting = {
            type : 'toast',
            infoText: msg,
            infoIcon: icons[type],
            autoClose: 1500,
            dialogClass: 'dialog_toast'
        };
        if (obj){
            obj.update(setting);
        } else {
            return $(document).dialog(setting);
        }
    }
    // 锁定屏幕
    function lock_touchmove(){
        $("body").bind("touchmove",function(event){event.preventDefault();});
    }
    // 解锁屏幕
    function un_lock_touchmove(){
        $("body").unbind("touchmove");
    }
    // 弹出框登录
    function logDialog() {
        // 是否需要刷新页面
        var isRefresh = arguments[0] === 0 ? arguments[0] : 1;
        // 页面跳转链接
        var urlValue = arguments[1] ? arguments[1] : '';
        if(qscms.is_login > 0 && urlValue){
            window.location.href = urlValue;
            return !1;
        }
        var utype = arguments[2] ? arguments[2] : 0;
        // 正在加载
        var $logLoad = qsToasting('', 0);
        var loginUrl = "{:U('AjaxCommon/ajax_login')}";
        $.getJSON(loginUrl, {refresh: isRefresh, url: urlValue, utype:utype}, function(result){
            $logLoad.close();
            if(result.status==1){
                var $logPop = new QSpopout('亲，验证一下手机吧');
                $logPop.setContent(result.data);
                $('.qs-popout-ft').remove();
                $('.qs-popout-bd').addClass('no-pd');
                $logPop.show();
                // 关闭
                $('.closePopout').on('click', function() {
                    $('#popout').fadeOut(200);
                    $('#popout').remove();
                });
            } else {
                qsToast(result.msg, '', '');
            }
        });
    }
    // 如果文档高度不大于窗口高度，数据较少，删除页面中的无数据提醒
    function removeDropLoadDown() {
        var doc = document;
        var $doc = $(doc);
        var $dropDownEle = $('.dropload-down');
        var scrollContentHeight = $doc.height();
        var scrollWindowHeight = doc.documentElement.clientHeight;
        var threshold = Math.floor($dropDownEle.height()*1/3);
        if((scrollContentHeight - threshold) <= scrollWindowHeight){
            $dropDownEle.remove();
        }
    }
    //判断是不是iPhoneX，适配iPhoneX底部遮挡问题
    if (funJudgeX()) {
        $('.fix-footNav').addClass('iPhoneX');
        $('body').addClass('iPhoneX');
    }
</script>
<div class="qs-hidden">{:htmlspecialchars_decode(C('qscms_statistics'))}</div>
        <script src="../public/js/qs.upScroll.js"></script>
		<script type="text/javascript">
        var tip = {
            jobs_display : '职位恢复后将会对外公开招聘，您确定要恢复选中的职位吗？',
            jobs_close : '职位关闭后将会暂停招聘，您确定要关闭选中的职位吗？',
            jobs_delete : '被删除后将无法恢复，您确定要删除选中的职位吗？'
        };
        // 职位刷新
		$('.J_refresh').on('click',function(){
            var obj = $(this);
            $.getJSON("{:U('Company/jobs_refresh_confirm')}",{yid:obj.attr('yid')},function(data){
                if(data.status==1){
                    if(data.data=='mix') {
                        $(document).dialog({
                            titleShow: false,
                            content: data.msg,
                            buttons: [
                                {
                                    name: '取消',
                                    callback: function() {}
                                }
                            ]
                        });
                    } else {
                        $(document).dialog({
                            titleShow: false,
                            content: data.msg,
                            onClickConfirmBtn: function(){
                                $.getJSON("{:U('Company/jobs_refresh')}",{yid:obj.attr('yid')},function(result){
                                    if (result.status == 1) {
                                        qsToast(result.msg, 1, '');
                                        setTimeout(function () {
                                            window.location.reload();
                                        }, 2000);
                                    } else {
                                        qsToast(result.msg, '', '');
                                        return false;
                                    }
                                });
                            }
                        });
                    }
                } else {
                    $(document).dialog({
                        titleText: '职位刷新',
                        content: data.msg
                    });
					return false;
                }
            });
		});
		// 职位推广
        $('.J_promotion').on('click', function() {
            var audit = $(this).data('audit'),
                display = $(this).data('display'),
                stick = $(this).data('stick'),
                stickMsg = $(this).data('stickmsg'),
                stickUrl = $(this).data('stickurl'),
                emergency = $(this).data('emergency'),
                emergencyMsg = $(this).data('emergencymsg'),
                emergencyUrl = $(this).data('emergencyurl'),
                auto = $(this).data('auto'),
                autoMsg = $(this).data('automsg'),
                autoUrl = $(this).data('autourl');
            if(audit == 2){
                qsToast('审核中的职位不能推广', '', '');
                return false;
            }
            if(audit == 3){
                qsToast('审核未通过的职位不能推广', '', '');
                return false;
            }
            if(display == 2){
                qsToast('已关闭的职位不能推广', '', '');
                return false;
            }
            var $scroll = new upScroll();
            $scroll.setContent(['职位置顶','紧急招聘','智能刷新']);
            $scroll.show();
            // 职位置顶
            $scroll.getList(1).on('click', function() {
                if (stick) {
                    $(document).dialog({
                        titleShow: false,
                        content: stickMsg,
                        buttons: [
                            {
                                name: '确定',
                                callback: function() {}
                            }
                        ]
                    });
                } else {
                    window.location.href = stickUrl;
                }
            });
            // 紧急招聘
            $scroll.getList(2).on('click', function() {
                if (emergency) {
                    $(document).dialog({
                        titleShow: false,
                        content: emergencyMsg,
                        buttons: [
                            {
                                name: '确定',
                                callback: function() {}
                            }
                        ]
                    });
                } else {
                    window.location.href = emergencyUrl;
                }
            });
            // 智能刷新
            $scroll.getList(3).on('click', function() {
                if (auto) {
                    $(document).dialog({
                        titleShow: false,
                        content: autoMsg,
                        buttons: [
                            {
                                name: '确定',
                                callback: function() {}
                            }
                        ]
                    });
                } else {
                    window.location.href = autoUrl;
                }
            });
        });
        // 更多
        $('.J_more').on('click', function() {
            var audit = $(this).data('audit'),
                display = $(this).data('display'),
                editUrl = $(this).data('editurl'),
                closeUrl = $(this).data('closeurl'),
                recoverUrl = $(this).data('recoverurl'),
                delUrl = $(this).data('delurl'),
                allowance = $(this).data('allowance'),
                allowanceUrl = $(this).data('allowanceurl');
            var moreArr = ['修改'];
            if (audit == 1) {
                if (display == 2) {
                    moreArr.push('恢复');
                } else {
                    moreArr.push('关闭');
                }
            }
            moreArr.push('删除');
            if (allowance) {
                moreArr.push('红包打赏');
            }
            var $scroll = new upScroll();
            $scroll.setContent(moreArr);
            $scroll.show();
            // 修改
            $scroll.getList(1).on('click', function() {
                $scroll.hide();
                window.location.href = editUrl;
            });
            if (audit == 1) {
                $scroll.getList(2).on('click', function() {
                    $scroll.hide();
                    if (display == 2) {
                        // 恢复
                        doFun(tip.jobs_display, recoverUrl);
                    } else {
                        // 关闭
                        doFun(tip.jobs_close, closeUrl);
                    }
                });
                // 删除
                $scroll.getList(3).on('click', function() {
                    $scroll.hide();
                    doFun(tip.jobs_delete, delUrl);
                });
                // 红包
                $scroll.getList(4).on('click', function() {
                    $scroll.hide();
                    window.location.href = allowanceUrl;
                });
            } else {
                // 删除
                $scroll.getList(2).on('click', function() {
                    $scroll.hide();
                    doFun(tip.jobs_delete, delUrl);
                });
                // 红包
                $scroll.getList(3).on('click', function() {
                    $scroll.hide();
                    window.location.href = allowanceUrl;
                });
            }
        });
        // 恢复、关闭、删除公用方法
        function doFun(content, url) {
            var $doDialog = $(document).dialog({
                type : 'confirm',
                titleText: '职位管理',
                content: content,
                onClickConfirmBtn: function(){
                    var cuToast = qsToasting('正在处理');
                    $.getJSON(url,function(result){
                        if(result.status==1){
                            qsToast(result.msg, 1, cuToast);
                            setTimeout(function(){
                                window.location.href = result.data;
                            },2000);
                        } else if(result.status==2){
                            $doDialog.close();
                            $(document).dialog({
                                overlayShow: false,
                                content: '<div class="dialog_notice">当前显示的职位已超过最大限制，建议您立即升级服务套餐或将暂时不招聘的职位设为关闭！</div>',
                                buttons: [
                                    {
                                        name: '取消',
                                        callback: function() {}
                                    },
                                    {
                                        name: '升级套餐',
                                        callback: function() {
                                            window.location.href = "{:U('CompanyService/setmeal_add')}";
                                        }
                                    }
                                ]
                            });
                        } else {
                            qsToast(result.msg, 0, cuToast);
                            return false;
                        }
                    });
                }
            });
        }
		// 发布职位
        $('#J_jobs_add').on('click',function(){
            $.getJSON("{:U('Company/check_jobs_num')}",function(result){
                if(result.status == 1){
                    var free = parseInt("{$setmeal['is_free']}"),
                        conHtml = '';
                    if(free==1){
                        conHtml = '<div class="dialog_notice">您当前是免费会员，发布中的职位数已超过最大限制，升级VIP会员后可继续发布职位，建议您立即升级VIP会员！</div>';
                    }else{
                        conHtml = '<div class="dialog_notice">当前显示的职位已超过最大限制，建议您立即升级服务套餐或将暂时不招聘的职位设为关闭！</div>';
                    }
                    $(document).dialog({
                        titleShow: false,
                        content: conHtml,
                        type : 'confirm',
                        buttons: [
                            {
                                name: '取消',
                                callback: function() {}
                            },
                            {
                                name: '升级套餐',
                                callback: function() {
                                    window.location.href = "{:U('CompanyService/setmeal_add')}";
                                }
                            }
                        ]
                    });
                } else {
                    window.location.href='{:U("Company/jobs_add")}';
                }
            });
        });
		</script>
	</body>
</html>